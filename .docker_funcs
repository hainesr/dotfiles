#!/bin/bash
#
# Bash docker functions.
#
# Robert Haines.
# Inspired by https://github.com/jfrazelle/dotfiles/blob/master/.dockerfunc
#
# BSD Licenced. See LICENCE for details.
#

# Add a cleanup helper to docker.
__real_docker=$(which docker)
docker() {
  if [[ $1 = 'cleanup' ]]; then
    $__real_docker rm -v $($__real_docker ps --filter status=exited -q 2>/dev/null) 2>/dev/null
    $__real_docker rmi $($__real_docker images --filter dangling=true -q 2>/dev/null) 2>/dev/null
  else
    $__real_docker "$@"
  fi
}

# Entrypoint into an Anaconda environment.
anaconda() {
  docker run -it --rm \
    --name anaconda \
    --volume=$(pwd):/opt/data \
    --volume=/tmp/.X11-unix:/tmp/.X11-unix \
    -e DISPLAY=unix$DISPLAY \
    -e LANG \
    continuumio/anaconda /bin/bash
}

# A generic helper for running tools in the document-processing image
compile_doc() {
  docker run -it --rm \
    --volume=$(pwd):/root/work \
    --volume=/tmp:/tmp \
    -u $UID \
    -e USER \
    hainesr/document-processing "$@"
}

# And a load of functions to run those document-processing tools
bibtex() { compile_doc bibtex "$@"; }
epstopdf() { compile_doc epstopdf "$@"; }
latex() { compile_doc latex "$@"; }
latexmk() { compile_doc latexmk "$@"; }
pdflatex() { compile_doc pdflatex "$@"; }
pandoc() { compile_doc pandoc "$@"; }
pslatex() { compile_doc pslatex "$@"; }
dvips() { compile_doc dvips "$@"; }

# Jekyll
jekyll() {
  docker run -it --rm \
    --name jekyll \
    --volume=$(pwd):/srv/jekyll \
    -u $UID \
    -p 4000:4000 \
    hainesr/jekyll "$@"
}

# mencoder
mencoder() {
  docker run -it --rm \
    --name mencoder \
    --volume=$(pwd):/home/mencoder/video \
    -u $UID \
    hainesr/mencoder "$@"
}

# p4merge
p4merge() {
  docker run -it --rm \
    --name p4merge \
    --volume=$HOME/.config/p4merge:/home/p4v/.p4merge \
    --volume=$HOME/.cache:/home/p4v/.cache \
    --volume=$(pwd):/opt/work \
    --volume=/tmp/.X11-unix:/tmp/.X11-unix \
    -e DISPLAY=unix$DISPLAY \
    -u $UID \
    hainesr/p4v p4merge "$@"
}

xnview() {
  local pics_dir=$(pwd)
  if [[ -d "$1" && -r "$1" ]]; then
    pics_dir=$(readlink -m "$1")
  fi

  docker run -it --rm \
    --name xnview \
    --volume=$HOME/.config/.xnviewmp:/home/xnview/.config/.xnviewmp \
    --volume=$HOME/.cache:/home/xnview/.cache \
    --volume="$pics_dir":/home/xnview/pics \
    --volume=/tmp/.X11-unix:/tmp/.X11-unix \
    -e DISPLAY=unix$DISPLAY \
    -u $UID \
    hainesr/xnview xnview
} > /dev/null

# Export all the functions so that they can be used in e.g. make.
for func in {anaconda,compile_doc,bibtex,epstopdf,latex,latexmk,pdflatex,pandoc,pslatex,dvips,jekyll,mencoder,p4merge,xnview}; do
  export -f $func
done
