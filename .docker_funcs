#!/bin/bash
#
# Bash docker functions.
#
# Robert Haines.
# Inspired by https://github.com/jfrazelle/dotfiles/blob/master/.dockerfunc
#
# BSD Licenced. See LICENCE for details.
#

# Add a cleanup helper to docker.
docker() {
  local real_docker=$(which docker)

  if [[ $1 = 'cleanup' ]]; then
    $real_docker rm -v $($real_docker ps --filter status=exited -q 2>/dev/null) 2>/dev/null
    $real_docker rmi $($real_docker images --filter dangling=true -q 2>/dev/null) 2>/dev/null
  else
    $real_docker "$@"
  fi
}

# A generic helper for running tools in the document-processing image
__doc_proc() {
  docker run -it --rm \
    --volume=$(pwd):/root/work \
    --volume=/tmp:/tmp \
    -u $UID \
    -e USER \
    hainesr/document-processing "$@"
}

# And a load of functions to run those document-processing tools
latex() { __doc_proc latex "$@"; }
latexmk() { __doc_proc latexmk "$@"; }
pdflatex() { __doc_proc pdflatex "$@"; }
pandoc() { __doc_proc pandoc "$@"; }

# Jekyll
jekyll() {
  docker run -it --rm \
    --name jekyll \
    --volume=$(pwd):/srv/jekyll \
    -p 4000:4000 \
    jekyll/jekyll:pages
}

# mencoder
mencoder() {
  docker run -it --rm \
    --name mencoder \
    --volume=$(pwd):/home/mencoder/video \
    -u $UID \
    hainesr/mencoder "$@"
}

# p4merge
p4merge() {
  docker run -it --rm \
    --name p4merge \
    --volume=$HOME/.config/p4merge:/home/p4v/.p4merge \
    --volume=$HOME/.cache:/home/p4v/.cache \
    --volume=$(pwd):/opt/work \
    --volume=/tmp/.X11-unix:/tmp/.X11-unix \
    -e DISPLAY=unix$DISPLAY \
    -u $UID \
    hainesr/p4v p4merge "$@"
}

xnview() {
  local pics_dir=$(pwd)
  if [[ -d "$1" && -r "$1" ]]; then
    pics_dir=$(readlink -m "$1")
  fi

  docker run -it --rm \
    --name xnview \
    --volume=$HOME/.config/.xnviewmp:/home/xnview/.config/.xnviewmp \
    --volume=$HOME/.cache:/home/xnview/.cache \
    --volume="$pics_dir":/home/xnview/pics \
    --volume=/tmp/.X11-unix:/tmp/.X11-unix \
    -e DISPLAY=unix$DISPLAY \
    -u $UID \
    hainesr/xnview xnview
} > /dev/null
